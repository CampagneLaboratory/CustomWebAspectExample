package org.campagnelab.circles.aspect.db;

/*Generated by MPS */

import com.orientechnologies.orient.core.record.impl.ODocument;
import com.orientechnologies.orient.core.db.document.ODatabaseDocumentTx;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.apache.log4j.Level;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import org.jetbrains.mps.openapi.model.SNodeAccessUtil;
import org.jetbrains.mps.openapi.language.SDataType;
import org.jetbrains.mps.openapi.language.SPrimitiveDataType;
import com.orientechnologies.orient.core.metadata.schema.OType;
import java.util.UUID;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import java.util.List;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import com.orientechnologies.orient.core.record.ORecord;
import org.apache.log4j.Logger;
import org.apache.log4j.LogManager;

public class DbNode {
  private ODocument doc;
  private ODatabaseDocumentTx db;

  public DbNode(ODatabaseDocumentTx db, SNode node) {
    this.doc = createNodeDoc(db, node.getConcept());
    this.db = db;
  }
  public DbNode(ODatabaseDocumentTx db, SAbstractConcept node) {
    this.doc = createNodeDoc(db, node);
    this.db = db;
  }
  public DbNode(ODatabaseDocumentTx db, ODocument doc) {
    this.doc = doc;
    this.db = db;
  }
  private ODocument createNodeDoc(ODatabaseDocumentTx db, SAbstractConcept concept) {
    if (db.getMetadata().getSchema().existsClass(DbClassNameUtil.getFqName(concept))) {
      return db.newInstance(DbClassNameUtil.getFqName(concept));
    } else {
      if (LOG.isEnabledFor(Level.WARN)) {
        LOG.warn("Trying to serialize a node whose concept is not in the DB Schema: " + DbClassNameUtil.getFqName(concept));
      }
      return null;
    }
  }
  public String renderToSvg(SNode source) {
    return "<svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" xmlns:jfreesvg=\"http://www.jfree.org/jfreesvg/svg\" width=\"656\" height=\"376\" text-rendering=\"auto\" shape-rendering=\"auto\">\n<defs><clipPath id=\"705421913357262clip-0\"><path d=\"M 0.0 0.0 L 20.0 0.0 L 20.0 20.0 L 0.0 20.0 L 0.0 0.0 Z \"/></clipPath>\n<clipPath id=\"705421913357262clip-1\"><path d=\"M 0.0 0.0 L 0.0 36.0 L 10.0 36.0 L 10.0 0.0 Z \"/></clipPath>\n<clipPath id=\"705421913357262clip-2\"><path d=\"M 0.0 0.0 L 0.0 40.0 L 12.0 40.0 L 12.0 0.0 Z \"/></clipPath>\n</defs>\n<g id=\"{&quot;moduleId&quot;=&quot;766a7fab-c925-4c96-b3e5-1f6a8e96f6d5&quot;, &quot;modelId&quot;=&quot;r:6a66b146-ac09-46e7-a5cf-62b1c04652a3&quot;, &quot;nodeId&quot;=&quot;4545757943691427566&quot;\"><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"25\" y=\"40\" style=\"fill: rgb(48,48,48); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" >build</text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"73\" y=\"40\" style=\"fill: rgb(0,0,0); fill-opacity: 1.0; font-family: monospace; font-size: 13px; \" >Testing</text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"137\" y=\"40\" style=\"fill: rgb(48,48,48); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" >generates</text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"217\" y=\"40\" style=\"fill: rgb(0,0,0); fill-opacity: 1.0; font-family: monospace; font-size: 13px; \" >build2.xml</text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"25\" y=\"57\" style=\"fill: rgb(128,128,128); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" ></text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"25\" y=\"76\" style=\"fill: rgb(48,48,48); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" >base directory:</text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"153\" y=\"76\" style=\"fill: rgb(0,0,0); fill-opacity: 1.0; font-family: monospace; font-size: 13px; \" >.</text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"153\" y=\"93\" style=\"fill: rgb(128,128,128); fill-opacity: 1.0; font-family: monospace; font-size: 13px; \" >/Users/fac2003/MPSProjects/git/Editor2PDF/solutions/Playground</text></g><rect x=\"0.0\" y=\"0.0\" width=\"20.0\" height=\"20.0\" style=\"fill: rgb(236,236,236); fill-opacity: 1.0\" transform=\"matrix(1.0,0.0,0.0,1.0,628.0,34.0)\" clip-path=\"url(#705421913357262clip-0)\"/><image preserveAspectRatio=\"none\" xlink:href=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAsCAYAAABcxymWAAABBUlEQVR42u2VPYqEUBCE5xZ7iznG3mJusSeaAyiYGRiICoriv6IGKuLvARSNau2BebC4arDhWtDZ97qrX1B9u/1VwzB8NE3z+a4N0LbtI8syz/d9WJYFwzCg6zp+dMjz/Om6LpIkQd/3WJYFbzGQIOrSdR1+ExtHnfYgBpKnOI5xpJe3o5EMpNVps3mez0FVVXGmFyjL8gVe4AX+V5CSYpqm85AyTRN1XR+DpDAM4TjOOViW5VPTNBRFcQyu4++UkYqi7MIsw1ePD9u2IUkSyPM6BeM4bkFaqqqqryiKQDZEUYQgCOB5HhzHYXOEKPjJc5qmCIIAnueBDsHe1brT/9IjskT1DRg613lOrzuwAAAAAElFTkSuQmCC\" clip-path=\"url(#705421913357262clip-1)\" transform=\"matrix(0.5,0.0,0.0,0.5,630.0,36.0)\" x=\"0.0\" y=\"0.0\" width=\"10.0\" height=\"44.0\"/>\n<image preserveAspectRatio=\"none\" xlink:href=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAsCAYAAAB/nHhDAAAARklEQVR42u3NMREAMAgEwTcaF7GFDlo0UGCDqPgqdzNXr+RuZo5zZeY615oDAAAAAAAAAAAAAAAA+AmIiHWuqlrn6u7r/AEccrFSW+vEagAAAABJRU5ErkJggg==\" clip-path=\"url(#705421913357262clip-2)\" transform=\"matrix(0.5,0.0,0.0,0.5,635.0,36.0)\" x=\"0.0\" y=\"0.0\" width=\"24.0\" height=\"44.0\"/>\n<image preserveAspectRatio=\"none\" xlink:href=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAsCAYAAABcxymWAAABBElEQVR42u2VzYmEQBSEJ4vNYsLYLDaLjWgCUPDmwYOooCj+K+pBRfwNQNFTLa8Zd5GZcbyvBX3qr18X71B1uRxV0zSf6xmG4eMlqOs6DMOAZVnwfR9Zlnlt2349gLhrWRb0fY8kSeC6LvI8v21+wBN1XcemE7wLrjBN/rWBHcVxzDy/BVcLzOseOM8z2witbhckqap6DJRl+QRP8AT/IzhN07GkqOsapmm+DynHcRCGIXZjrygKaJqGsixvL0GCFEVZs/G6AcdxpNfMkyRJsG2bPP61A8dx4HkegiBAFEX2XRRFqKrqe9MKFOie5yEIAqRpyjxRwD+UE42nQ5f39ro+K64fIzvXeZLbzGIAAAAASUVORK5CYII=\" clip-path=\"url(#705421913357262clip-1)\" transform=\"matrix(0.5,0.0,0.0,0.5,641.0,36.0)\" x=\"0.0\" y=\"0.0\" width=\"10.0\" height=\"44.0\"/>\n<g transform=\"matrix(1.0,0.0,0.0,1.0,628.0,34.0)\"><text x=\"4.0\" y=\"15.0\" style=\"fill: rgb(29,29,29); fill-opacity: 1.0; font-family: Helvetica Neue; font-size: 13px; \" clip-path=\"url(#705421913357262clip-0)\">...</text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"25\" y=\"110\" style=\"fill: rgb(128,128,128); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" ></text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"25\" y=\"127\" style=\"fill: rgb(48,48,48); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" >use plugins:</text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"41\" y=\"144\" style=\"fill: rgb(128,128,128); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" >&lt;&lt; ... &gt;&gt;</text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"25\" y=\"161\" style=\"fill: rgb(128,128,128); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" ></text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"25\" y=\"178\" style=\"fill: rgb(48,48,48); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" >macros:</text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"41\" y=\"195\" style=\"fill: rgb(128,128,128); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" >&lt;&lt; ... &gt;&gt;</text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"25\" y=\"212\" style=\"fill: rgb(128,128,128); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" ></text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"25\" y=\"229\" style=\"fill: rgb(48,48,48); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" >dependencies:</text></g><g id=\"{&quot;moduleId&quot;=&quot;766a7fab-c925-4c96-b3e5-1f6a8e96f6d5&quot;, &quot;modelId&quot;=&quot;r:6a66b146-ac09-46e7-a5cf-62b1c04652a3&quot;, &quot;nodeId&quot;=&quot;4545757943691427598&quot;\"><rect x=\"41\" y=\"233\" width=\"120\" height=\"17\" style=\"fill: rgb(255,220,220); fill-opacity: 1.0\" transform=\"matrix(1,0,0,1,-25,-27)\" /><rect x=\"41\" y=\"233\" width=\"120\" height=\"17\" style=\"fill: rgb(255,220,220); fill-opacity: 1.0\" transform=\"matrix(1,0,0,1,-25,-27)\" /><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"41\" y=\"246\" style=\"fill: rgb(255,0,0); fill-opacity: 1.0; font-family: monospace; font-size: 13px; \" >&lt;no dependency&gt;</text></g><rect x=\"0.0\" y=\"0.0\" width=\"121.0\" height=\"3.0\" style=\"fill: black;; fill-opacity: 1.0\" transform=\"matrix(1.0,0.0,0.0,1.0,15.0,221.0)\" /></g>\n<g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"25\" y=\"263\" style=\"fill: rgb(128,128,128); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" ></text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"25\" y=\"280\" style=\"fill: rgb(48,48,48); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" >project structure:</text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"41\" y=\"297\" style=\"fill: rgb(128,128,128); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" >&lt;&lt; ... &gt;&gt;</text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"25\" y=\"314\" style=\"fill: rgb(128,128,128); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" ></text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"25\" y=\"331\" style=\"fill: rgb(48,48,48); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" >default layout:</text></g><g id=\"{&quot;moduleId&quot;=&quot;766a7fab-c925-4c96-b3e5-1f6a8e96f6d5&quot;, &quot;modelId&quot;=&quot;r:6a66b146-ac09-46e7-a5cf-62b1c04652a3&quot;, &quot;nodeId&quot;=&quot;4545757943691427568&quot;\"><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"41\" y=\"348\" style=\"fill: rgb(128,128,128); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" >&lt;empty&gt;</text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"41\" y=\"365\" style=\"fill: rgb(128,128,128); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" ></text></g></g>\n<g id=\"{&quot;moduleId&quot;=&quot;766a7fab-c925-4c96-b3e5-1f6a8e96f6d5&quot;, &quot;modelId&quot;=&quot;r:6a66b146-ac09-46e7-a5cf-62b1c04652a3&quot;, &quot;nodeId&quot;=&quot;4545757943691427602&quot;\"><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"25\" y=\"382\" style=\"fill: rgb(48,48,48); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" >workflow</text></g><g id=\"{&quot;moduleId&quot;=&quot;766a7fab-c925-4c96-b3e5-1f6a8e96f6d5&quot;, &quot;modelId&quot;=&quot;r:6a66b146-ac09-46e7-a5cf-62b1c04652a3&quot;, &quot;nodeId&quot;=&quot;4545757943691427605&quot;\"><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"41\" y=\"399\" style=\"fill: rgb(48,48,48); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" >ant taskdef</text></g><rect x=\"137\" y=\"386\" width=\"72\" height=\"17\" style=\"fill: rgb(255,220,220); fill-opacity: 1.0\" transform=\"matrix(1,0,0,1,-25,-27)\" /><rect x=\"137\" y=\"386\" width=\"72\" height=\"17\" style=\"fill: rgb(255,220,220); fill-opacity: 1.0\" transform=\"matrix(1,0,0,1,-25,-27)\" /><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"137\" y=\"399\" style=\"fill: rgb(255,0,0); fill-opacity: 1.0; font-family: monospace; font-size: 13px; \" >&lt;no name&gt;</text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"217\" y=\"399\" style=\"fill: rgb(48,48,48); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" >class</text></g><rect x=\"265\" y=\"386\" width=\"136\" height=\"17\" style=\"fill: rgb(255,220,220); fill-opacity: 1.0\" transform=\"matrix(1,0,0,1,-25,-27)\" /><rect x=\"265\" y=\"386\" width=\"136\" height=\"17\" style=\"fill: rgb(255,220,220); fill-opacity: 1.0\" transform=\"matrix(1,0,0,1,-25,-27)\" /><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"265\" y=\"399\" style=\"fill: rgb(255,0,0); fill-opacity: 1.0; font-family: monospace; font-size: 13px; \" >&lt;full class name&gt;</text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"409\" y=\"399\" style=\"fill: rgb(48,48,48); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" >from</text></g><g transform=\"matrix(1,0,0,1,-25,-27)\"><text x=\"449\" y=\"399\" style=\"fill: rgb(128,128,128); fill-opacity: 1.0; font-family: monospace; font-size: 13px; font-weight: bold; \" >&lt;default classpath&gt;</text></g></g>\n</g>\n</g>\n</svg>";
  }
  public void populate(SNode source, ODocument parentModel, DbCache cache) {
    if (this.doc == null) {
      return;
    }
    SConcept sourceConcept = source.getConcept();

    // populate properties 
    for (SProperty p : CollectionSequence.fromCollection(sourceConcept.getProperties())) {
      if (LOG.isInfoEnabled()) {
        LOG.info("Checking property " + p.getName());
      }
      if (!((doc.getSchemaClass().existsProperty(DbClassNameUtil.make(p.getName()))))) {
        continue;
      }
      String value = SNodeAccessUtil.getProperty(source, p.getName());
      SDataType type = p.getType();
      if (type instanceof SPrimitiveDataType) {
        switch (((SPrimitiveDataType) type).getType()) {
          case SPrimitiveDataType.BOOL:
            doc.field(DbClassNameUtil.make(p.getName()), Boolean.valueOf(value));
            break;
          case SPrimitiveDataType.INT:
            doc.field(DbClassNameUtil.make(p.getName()), Integer.valueOf(value));
            break;
          case SPrimitiveDataType.STRING:
          default:
            doc.field(DbClassNameUtil.make(p.getName()), value);
        }
      }
    }
    doc.field("nodeId", source.getNodeId().toString(), OType.STRING);
    doc.field("model", parentModel);
    doc.field("id", UUID.randomUUID().toString(), OType.STRING);

    if (source.getContainingRoot() == source || source.getContainingRoot() == null) {
      //  it's a root node 
      if (LOG.isInfoEnabled()) {
        LOG.info("Rendering root node:" + source);
      }
      doc.field("svgRendering", renderToSvg(source), OType.STRING);
    }

    // populate children 
    for (SContainmentLink childRole : CollectionSequence.fromCollection(sourceConcept.getContainmentLinks())) {
      if (!((doc.getSchemaClass().existsProperty(DbClassNameUtil.make(childRole.getName()))))) {
        continue;
      }
      List<ODocument> childDocs = new ArrayList<ODocument>();
      for (SNode child : Sequence.fromIterable(source.getChildren(childRole))) {
        if (child != null) {
          DbNode childNode = new DbNode(db, childRole.getTargetConcept());
          childNode.populate(child, parentModel, cache);
          childDocs.add(childNode.asDoc());
          cache.addNode(child);
        }
      }
      if (childDocs.size() == 0) {
        continue;
      }
      if (childRole.isMultiple()) {
        doc.field(DbClassNameUtil.make(childRole.getName()), childDocs);
      } else {
        doc.field(DbClassNameUtil.make(childRole.getName()), childDocs.get(0));
      }
    }

    this.save();
  }
  public void resolveRefs(SNode source, DbCache cache) {
    if (LOG.isInfoEnabled()) {
      LOG.info("Resolving refs for node " + source.getNodeId() + " " + source.getConcept().getName());
    }
    SConcept sourceConcept = source.getConcept();
    // populate links 
    for (SReferenceLink referenceLink : CollectionSequence.fromCollection(sourceConcept.getReferenceLinks())) {
      SNode refNode = source.getReferenceTarget(referenceLink);
      if (!((this.doc.getSchemaClass().existsProperty(DbClassNameUtil.make(referenceLink.getRoleName())))) || !(cache.exist(refNode))) {
        continue;
      }
      if (LOG.isInfoEnabled()) {
        LOG.info("Role ref " + referenceLink.getRoleName() + " found");
      }
      this.doc.field(referenceLink.getRoleName(), DbAccess.lookupNode(db, refNode));
    }
    this.save();
  }
  private ORecord getLinkedField(ODatabaseDocumentTx db, ODocument node, SReferenceLink ref) {
    if (db.getMetadata().getSchema().existsClass(DbClassNameUtil.getFqName(ref.getTargetConcept()))) {
      return node.field(ref.getRoleName(), DbClassNameUtil.getFqName(ref.getTargetConcept()));
    }
    return null;
  }

  public ODocument asDoc() {
    return this.doc;
  }
  public void save() {
    if (this.doc != null) {
      this.doc.save();
    }
  }

  protected static Logger LOG = LogManager.getLogger(DbNode.class);
}
